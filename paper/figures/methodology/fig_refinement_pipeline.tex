% ============================================================================
%  Refinement Pipeline Figure — two-stage post-partition refinement
% ============================================================================
\begin{figure}[t]
    \centering
    \resizebox{\linewidth}{!}{%
    \begin{tikzpicture}[
        >=stealth,
        node distance=0.3cm and 1.5cm,
        stage/.style={
            rectangle, rounded corners=4pt, draw=#1!70, thick,
            fill=#1!10, minimum width=4.5cm, minimum height=1.2cm,
            text centered, font=\small\bfseries, text width=4.2cm
        },
        detail/.style={
            rectangle, rounded corners=2pt, draw=black!30,
            fill=white, minimum width=4.0cm, minimum height=0.6cm,
            text centered, font=\scriptsize, text width=3.8cm
        },
        io/.style={
            rounded rectangle, draw=black!50, fill=gray!8,
            minimum width=3.5cm, minimum height=0.8cm,
            text centered, font=\small
        },
        arrow/.style={->, very thick, black!60},
        note/.style={font=\scriptsize\itshape, text=gray!60, text width=3.2cm, align=left},
    ]

    % ── Input ──
    \node[io] (input) {Leiden partition};

    % ── Stage 1: Hausdorff split ──
    \node[stage=red, below=0.7cm of input] (split) {Hausdorff Splitting};
    \node[detail, below=0.1cm of split] (split1) {Pairwise Hausdorff distances};
    \node[detail, below=0.05cm of split1] (split2) {Average linkage dendrogram};
    \node[detail, below=0.05cm of split2] (split3) {Cut at $\tau_\text{split}$ (ARI-selected)};

    \node[note, right=0.8cm of split] {Impure clusters\\$\to$ visually coherent\\sub-clusters};

    % ── Stage 2: Label split ──
    \node[stage=blue, below=0.7cm of split3] (lsplit) {Label-Based Splitting};
    \node[detail, below=0.1cm of lsplit] (lsplit1) {Group members by OCR label};
    \node[detail, below=0.05cm of lsplit1] (lsplit2) {$\ge 2$ members $\to$ sub-cluster};
    \node[detail, below=0.05cm of lsplit2] (lsplit3) {Unknowns $\to$ dominant group};

    \node[note, right=0.8cm of lsplit] {Enforce label\\consistency\\(no GPU)};

    % ── Output ──
    \node[io, below=0.7cm of lsplit3] (output) {Refined clusters};

    % ── Arrows ──
    \draw[arrow] (input) -- (split);
    \draw[arrow] (split3.south) -- ++(0,-0.2) -| ([xshift=0cm]lsplit.north);
    \draw[arrow] (lsplit3.south) -- ++(0,-0.2) -| ([xshift=0cm]output.north);

    % ── Stage labels ──
    \node[left=0.6cm of split, font=\footnotesize\bfseries, text=red!70] {Stage 1};
    \node[left=0.6cm of lsplit, font=\footnotesize\bfseries, text=blue!70] {Stage 2};

    \end{tikzpicture}%
    }
    \caption{Two-stage cluster refinement pipeline.
    After the initial Leiden partition, clusters are split by visual dissimilarity via Hausdorff distances (Stage~1), then split by OCR label consistency (Stage~2).
    Each stage is composable and produces structured diagnostics for reporting.}
    \label{fig:refinement-pipeline}
\end{figure}
