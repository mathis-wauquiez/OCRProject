% ============================================================================
%  Refinement Pipeline Figure — two-stage post-partition refinement
% ============================================================================
\begin{figure}[t]
    \centering
    \resizebox{\linewidth}{!}{%
    \begin{tikzpicture}[
        >=stealth,
        node distance=0.3cm and 1.5cm,
        stage/.style={
            rectangle, rounded corners=4pt, draw=#1!70, thick,
            fill=#1!10, minimum width=4.5cm, minimum height=1.2cm,
            text centered, font=\small\bfseries, text width=4.2cm
        },
        detail/.style={
            rectangle, rounded corners=2pt, draw=black!30,
            fill=white, minimum width=4.0cm, minimum height=0.6cm,
            text centered, font=\scriptsize, text width=3.8cm
        },
        io/.style={
            rounded rectangle, draw=black!50, fill=gray!8,
            minimum width=3.5cm, minimum height=0.8cm,
            text centered, font=\small
        },
        arrow/.style={->, very thick, black!60},
        note/.style={font=\scriptsize\itshape, text=gray!60, text width=3.2cm, align=left},
    ]

    % ── Input ──
    \node[io] (input) {Leiden partition};

    % ── Stage 1: Hausdorff split ──
    \node[stage=red, below=0.7cm of input] (split) {Hausdorff Splitting};
    \node[detail, below=0.1cm of split] (split1) {Pairwise IC registration + Hausdorff};
    \node[detail, below=0.05cm of split1] (split2) {Average linkage dendrogram};
    \node[detail, below=0.05cm of split2] (split3) {Cut at $\tau_\text{split}$; unknowns $\to$ largest sub-cluster};

    \node[note, right=0.8cm of split] {Impure clusters\\$\to$ visually coherent\\sub-clusters};

    % ── Stage 2: OCR-guided PCA rematch ──
    \node[stage=blue, below=0.7cm of split3] (pca) {OCR-Guided PCA Rematching};
    \node[detail, below=0.1cm of pca] (pca1) {Small clusters ($\le 3$): find dominant OCR label};
    \node[detail, below=0.05cm of pca1] (pca2) {Candidates: large clusters with same label};
    \node[detail, below=0.05cm of pca2] (pca3) {IC register query $\to$ candidate anchor};
    \node[detail, below=0.05cm of pca3] (pca4) {PCA projection + z-score compatibility test};

    \node[note, right=0.8cm of pca] {OCR narrows candidates,\\PCA validates merge\\in image space};

    % ── Output ──
    \node[io, below=0.7cm of pca4] (output) {Refined clusters};

    % ── Arrows ──
    \draw[arrow] (input) -- (split);
    \draw[arrow] (split3.south) -- ++(0,-0.2) -| ([xshift=0cm]pca.north);
    \draw[arrow] (pca4.south) -- ++(0,-0.2) -| ([xshift=0cm]output.north);

    % ── Stage labels ──
    \node[left=0.6cm of split, font=\footnotesize\bfseries, text=red!70] {Stage 1};
    \node[left=0.6cm of pca, font=\footnotesize\bfseries, text=blue!70] {Stage 2};

    \end{tikzpicture}%
    }
    \caption{Two-stage cluster refinement pipeline.
    After the initial Leiden partition, clusters are split by visual dissimilarity (Stage~1), then small fragments are merged back using OCR-guided candidate selection validated by PCA z-score compatibility (Stage~2).}
    \label{fig:refinement-pipeline}
\end{figure}
