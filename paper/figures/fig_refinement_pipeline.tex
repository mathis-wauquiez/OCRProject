% ============================================================================
%  Refinement Pipeline Figure — three-stage post-partition refinement
% ============================================================================
\begin{figure}[t]
    \centering
    \resizebox{\linewidth}{!}{%
    \begin{tikzpicture}[
        >=stealth,
        node distance=0.3cm and 1.5cm,
        stage/.style={
            rectangle, rounded corners=4pt, draw=#1!70, thick,
            fill=#1!10, minimum width=4.5cm, minimum height=1.2cm,
            text centered, font=\small\bfseries, text width=4.2cm
        },
        detail/.style={
            rectangle, rounded corners=2pt, draw=black!30,
            fill=white, minimum width=4.0cm, minimum height=0.6cm,
            text centered, font=\scriptsize, text width=3.8cm
        },
        io/.style={
            rounded rectangle, draw=black!50, fill=gray!8,
            minimum width=3.5cm, minimum height=0.8cm,
            text centered, font=\small
        },
        arrow/.style={->, very thick, black!60},
        note/.style={font=\scriptsize\itshape, text=gray!60, text width=3.2cm, align=left},
    ]

    % ── Input ──
    \node[io] (input) {Leiden partition};

    % ── Stage 1: Hausdorff split ──
    \node[stage=red, below=0.7cm of input] (split) {Hausdorff Splitting};
    \node[detail, below=0.1cm of split] (split1) {Pairwise IC registration + Hausdorff};
    \node[detail, below=0.05cm of split1] (split2) {Average linkage dendrogram};
    \node[detail, below=0.05cm of split2] (split3) {Cut at $\tau_\text{split}$; unknowns $\to$ largest sub-cluster};

    \node[note, right=0.8cm of split] {Impure clusters\\$\to$ visually coherent\\sub-clusters};

    % ── Stage 2: OCR rematch ──
    \node[stage=blue, below=0.7cm of split3] (ocr) {OCR Rematching};
    \node[detail, below=0.1cm of ocr] (ocr1) {Small clusters ($\le 3$): find dominant label};
    \node[detail, below=0.05cm of ocr1] (ocr2) {Merge into largest cluster with same label};

    \node[note, right=0.8cm of ocr] {Fast, label-driven\\(no GPU)};

    % ── Stage 3: PCA rematch ──
    \node[stage=green!70!black, below=0.7cm of ocr2] (pca) {PCA Z-Score Rematching};
    \node[detail, below=0.1cm of pca] (pca1) {$k$-NN candidate clusters (HOG distance)};
    \node[detail, below=0.05cm of pca1] (pca2) {IC register query $\to$ anchor};
    \node[detail, below=0.05cm of pca2] (pca3) {PCA projection + z-score test};

    \node[note, right=0.8cm of pca] {Image-space\\compatibility test\\for remaining singletons};

    % ── Output ──
    \node[io, below=0.7cm of pca3] (output) {Refined clusters};

    % ── Arrows ──
    \draw[arrow] (input) -- (split);
    \draw[arrow] (split3.south) -- ++(0,-0.2) -| ([xshift=0cm]ocr.north);
    \draw[arrow] (ocr2.south) -- ++(0,-0.2) -| ([xshift=0cm]pca.north);
    \draw[arrow] (pca3.south) -- ++(0,-0.2) -| ([xshift=0cm]output.north);

    % ── Stage labels ──
    \node[left=0.6cm of split, font=\footnotesize\bfseries, text=red!70] {Stage 1};
    \node[left=0.6cm of ocr, font=\footnotesize\bfseries, text=blue!70] {Stage 2};
    \node[left=0.6cm of pca, font=\footnotesize\bfseries, text=green!50!black] {Stage 3};

    \end{tikzpicture}%
    }
    \caption{Three-stage cluster refinement pipeline.
    After the initial Leiden partition, clusters are sequentially split by visual dissimilarity (Stage~1), merged by OCR label (Stage~2), and merged by image-space PCA compatibility (Stage~3).
    Each stage is composable and produces structured diagnostics for reporting.}
    \label{fig:refinement-pipeline}
\end{figure}
